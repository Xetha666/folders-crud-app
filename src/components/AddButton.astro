---
import Carpet from "public/svg/carpet.svg";
import InstructorIcon from "public/svg/instructor.svg";
import Procedencia from "public/svg/procedencia.svg";
import Modal from "@/components/Modal.astro";
import AddIcon from "public/svg/add-icon.svg";
import ViewIcon from "public/svg/eye-visibility.svg";
import DeleteIcon from "public/svg/delete-icon.svg";
import { ACTIONS } from "@/data/button";
import { db,Precedence,Instructor,Grade,Fiscal,eq } from "astro:db";

const iconComponents: Record<string, any> = {
  IconProcedencia: Procedencia,
  IconInstructor: InstructorIcon,
  IconCarpet: Carpet,
}

// Obtener el rol del usuario
const user = Astro.locals.user;
const isUserAdmin = user?.role === "admin";

// Solo los admin pueden ver los botones
const filteredActions = isUserAdmin ? ACTIONS : [];

const listPrecedences = await db.select().from(Precedence)
const listInstructors = await db.select().from(Instructor).
                        innerJoin(Grade, eq(Instructor.idGrade, Grade.idGrade))
const listGrades = await db.select().from(Grade)
const listFiscals = await db.select().from(Fiscal)
const listGenre = [{name: "Masculino"}, {name: "Femenino"}]
---

<div class="flex flex-wrap gap-4 p-4">
  {filteredActions.map(({ id, label, icon, colorClass }) => {
    const Icon = iconComponents[icon];
    return (
      <button class={`btn text-white shadow-lg transition-all duration-300 ${colorClass}`} data-target={id}>
        <Icon class="size-5" />
      {label}
    </button>
  )})}

  <!-- Button Agregar Carpeta -->
  <button class="btn text-white shadow-lg transition-all duration-300 btn-warning border-warning shadow-warning/20 hover:shadow-warning/40" data-target="modal_carpet">
  <Carpet class="size-5" />
      Agregar Carpetas
  </button>
</div>

{filteredActions.map(({ id }) => {
  const isProcedencia = id === "modal_procedencia";
  const isInstructor = id === "modal_instructor";
  const actionLabel = isProcedencia ? "Procedencia" : isInstructor ? "Instructor" : "Fiscal";
  const pluralActionLabel = isProcedencia ? "Procedencias" : isInstructor ? "Instructores" : "Fiscales";
  return(
    <Modal id={id} formClass="pt-6">
      <div class="flex flex-col gap-6">
            {/* BOTÓN AGREGAR */}
            <button class="cursor-pointer group flex flex-col items-center justify-center p-6 rounded-xl border-2 border-success/30 bg-success/5 hover:bg-success/10 hover:border-success transition-all duration-300 gap-3" data-target={`${id}_add`}>
              <div class="p-3 rounded-full bg-success/20 group-hover:scale-110 transition-transform">
                <AddIcon class="size-8 text-success"/>
              </div>
              <span class="font-bold uppercase tracking-tighter text-sm text-success">Agregar {actionLabel}</span>
            </button>

            {/* BOTÓN ELIMINAR */}
            <button class="cursor-pointer group flex flex-col items-center justify-center p-6 rounded-xl border-2 border-info/30 bg-info/5 hover:bg-info/10 hover:border-info transition-all duration-300 gap-3" data-target={`${id}_view`}>
              <div class="p-3 rounded-full group-hover:scale-110 transition-transform">
                <ViewIcon class="size-8 text-info"  />
              </div>
              <span class="font-bold uppercase tracking-tighter text-sm text-info">Ver {pluralActionLabel}</span>
            </button>
          </div>
    </Modal>
    )
})}

<!--Agregar Carpeta / Formulario -->
<Modal id="modal_carpet">
  <div class="flex flex-col gap-6">
    <div class="space-y-1 text-center">
      <p class="text-gray-400 text-sm text-left">Gestión de carpetas fiscales y policiales.</p>
      <div class="h-0.5 w-16 bg-police/50"></div>
    </div>

    <button class="cursor-pointer group flex flex-col items-center justify-center p-6 rounded-xl border-2 border-warning/30 bg-warning/5 hover:bg-warning/10 hover:border-warning transition-all duration-300 gap-3">
      <div class="p-3 rounded-full bg-warning/20 group-hover:scale-110 transition-transform">
        <AddIcon class="size-8 text-warning"/>
      </div>
      <span class="font-bold uppercase tracking-tighter text-sm text-warning">Nueva Carpeta</span>
    </button>

    <button class="group flex flex-col items-center justify-center p-6 rounded-xl border-2 border-error/30 bg-error/5 hover:bg-error/10 hover:border-error transition-all duration-300 gap-3">
      <div class="p-3 rounded-full bg-error/20 group-hover:scale-110 transition-transform">
        <ViewIcon class="size-8 text-error" />
      </div>
      <span class="font-bold uppercase tracking-tighter text-sm text-error">Eliminar Carpeta</span>
    </button>
  </div>
</Modal>

{/* Modales secundarios para Agregar/Eliminar */}
{filteredActions.map(({ id, firstInput, firstExample, secondInput, secondExample, placeholder }) => {
  const isProcedencia = id === "modal_procedencia";
  const isInstructor = id === "modal_instructor";
  const actionLabel = isProcedencia ? "Procedencia" : isInstructor ? "Instructor" : "Fiscal";
  const pluralActionLabel = isProcedencia ? "Procedencias" : isInstructor ? "Instructores" : "Fiscales";
  
  return (
    <>
      {/* Modal para Agregar */}
      <Modal id={`${id}_add`}>
        <h2 class="text-2xl font-bold text-success">Agregar {actionLabel}</h2>
        <form id={`form-add-${actionLabel.toLowerCase()}`} data-type={actionLabel.toLowerCase()} class="flex flex-col">
          
          <div class="flex flex-col">

            <label for={`id-${actionLabel.toLowerCase()}`} class="text-gray-400 text-base font-bold mt-4">{firstInput}</label>
            <label for={`id-${actionLabel.toLowerCase()}`} class="text-gray-400 text-xs">{(firstExample)}</label>
              <input 
                type="text" 
                name={`${actionLabel}`}
                id={`id-${actionLabel.toLowerCase()}`}
                class="input input-bordered input-lg w-full bg-tactical-dark/50 border-success/30 focus:outline-none text-white text-base mt-2" 
                placeholder={`${placeholder}`}
                required
              />

            <label for={`new_${actionLabel.toLowerCase()}`} class="text-gray-400 text-base font-bold mt-2">{secondInput}</label>
            <label for={`new_${actionLabel.toLowerCase()}`} class="text-gray-400 text-xs">{(secondExample)}</label>
              {isProcedencia ? (
                <input type="text" name={`new_${actionLabel.toLowerCase()}`} id={`fullname-${actionLabel.toLowerCase()}`}class="input input-bordered input-lg w-full bg-tactical-dark/50 border-success/30 focus:outline-none text-white text-base mt-2" 
                  placeholder={`Escribe la ${actionLabel.toLowerCase()} aquí...`}
                  required
                />
                ) : isInstructor ? (                              
                    <select name={`new_${actionLabel.toLowerCase()}`} id={`grade-${actionLabel.toLowerCase()}`} class="cursor-pointer select select-bordered select-lg w-full bg-tactical-dark/50 border-success/30 focus:outline-none text-white/50 text-base mt-2">
                      <option disabled selected hidden value="" class="text-white/50 bg-tactical-dark">-Seleccione el grado-</option>
                      {listGrades.map((grade) => (
                        <option value={grade.nameGrade} class="bg-tactical-dark text-white/60">{grade.nameGrade}</option>
                      ))}
                    </select>
                ) : (
                  <select name={`new_${actionLabel.toLowerCase()}`} id={`genre-${actionLabel.toLowerCase()}`} class="select select-bordered select-lg w-full bg-tactical-dark/50 border-success/30 text-white/50 text-base mt-2 focus:outline-none focus:bg-tactical-dark valid:bg-tactical-dark">     
                    <option disabled selected hidden value="" class="text-white/50 bg-tactical-dark">-Seleccione el genero-</option>
                    {listGenre.map((genre) => (
                      <option value={genre.name} class="bg-tactical-dark text-white/60">{genre.name}</option>
                    ))}
                  </select>
                )}
          </div>

          <div class="flex gap-3 justify-end mt-4">
            <button type="button" class="btn btn-ghost text-gray-400" onclick="this.closest('dialog').close()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-success">
              <AddIcon class="size-4" />
              Agregar
            </button>
          </div>
        </form>
      </Modal>

      {/* Modal de Listados */}
      <Modal id={`${id}_view`}>
        <h2 class="text-2xl font-bold text-info">Listado de {pluralActionLabel}</h2>
        <form class="flex flex-col gap-6">
          <div class="form-control">
            {isProcedencia ? listPrecedences.map((precedence) => (
                  <div class="flex items-center justify-between p-2">
                    <span class="flex flex-col">
                      <p>{precedence.namePrecedence}</p>
                      <p class="text-xs text-gray-400 text-left max-w-xs">{precedence.realNamePrecedence}</p>
                    </span>
                    <button type="button" class="btn btn-error btn-sm delete-btn" data-id={precedence.idPrecedence} data-type="precedencia">
                      <DeleteIcon class="size-4" />                  
                    </button>
                  </div>
                ))
              : isInstructor ? listInstructors.map((instructor) => (
                  <div class="flex items-center justify-between p-2">
                    <span class="flex flex-col">
                      <p>{instructor.Grade.shortNameGrade}. PNP {instructor.Instructor.nameInstructor}</p>
                      <p class="text-xs text-gray-400 text-left max-w-xs">{instructor.Grade.nameGrade}</p>
                    </span>
                    <button type="button" class="btn btn-error btn-sm delete-btn" data-id={instructor.Instructor.idInstructor} data-type="instructor">
                      <DeleteIcon class="size-4" />                  
                    </button>
                  </div>
                ))
              : (
                <>
                  {/* Fiscales Femeninas */}
                  <div class="mb-2 mt-4">
                    <h3 class="text-xl font-semibold text-pink-500 mb-2 px-2">Femenino</h3>
                    {listFiscals.filter(fiscal => fiscal.genreFiscal === "Femenino").map((fiscal) => (
                      <div class="flex items-center justify-between p-2">
                        <span class="flex flex-col">
                          <p>{fiscal.nameFiscal}</p>
                        </span>
                        <button type="button" class="btn btn-error btn-sm delete-btn" data-id={fiscal.idFiscal} data-type="fiscal">
                          <DeleteIcon class="size-4" />                  
                        </button>
                      </div>
                    ))}
                  </div>

                  {/* Fiscales Masculinos */}
                  <div>
                    <h3 class="text-xl font-semibold text-blue-500 mb-2 px-2">Masculino</h3>
                    {listFiscals.filter(fiscal => fiscal.genreFiscal === "Masculino").map((fiscal) => (
                      <div class="flex items-center justify-between p-2">
                        <span class="flex flex-col">
                          <p>{fiscal.nameFiscal}</p>
                        </span>
                        <button type="button" class="btn btn-error btn-sm">
                          <DeleteIcon class="size-4" />                  
                        </button>
                      </div>
                    ))}
                  </div>
                </>
              )
            }
          </div>
        </form>
      </Modal>
    </>
  );
})}

<script>
  const setupModals = () => {
    const modalButtons = document.querySelectorAll('[data-target]');

    modalButtons.forEach(button => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        const targetId = button.getAttribute('data-target');
        if (!targetId) return;
        const modal = document.getElementById(targetId) as HTMLDialogElement;
        modal?.showModal();
      });
    });
  };

  // Setup form submission handlers
  const setupFormHandlers = () => {
    const forms = document.querySelectorAll('form[id^="form-add-"]') as NodeListOf<HTMLFormElement>;
    
    forms.forEach(form => {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        const formType = form.getAttribute('data-type');
        if (!formType) return;
        
        let endpoint = '';
        let payload: Record<string, any> = {};
        
        if (formType === 'procedencia') {
          const shortName = (document.getElementById('id-procedencia') as HTMLInputElement)?.value;
          const fullName = (document.getElementById('fullname-procedencia') as HTMLInputElement)?.value;
          
          endpoint = '/api/precedence';
          payload = {
            namePrecedence: shortName,
            realNamePrecedence: fullName
          };
        } 
        else if (formType === 'instructor') {
          const name = (document.getElementById('id-instructor') as HTMLInputElement)?.value;
          const grade = (document.getElementById('grade-instructor') as HTMLSelectElement)?.value;
          
          endpoint = '/api/instructor';
          payload = {
            nameInstructor: name,
            nameGrade: grade
          };
        } 
        else if (formType === 'fiscal') {
          const name = (document.getElementById('id-fiscal') as HTMLInputElement)?.value;
          const genre = (document.getElementById('genre-fiscal') as HTMLSelectElement)?.value;
          
          endpoint = '/api/fiscal';
          payload = {
            nameFiscal: name,
            genreFiscal: genre
          };
        }
        
        try {
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
          });
          
          console.log('Response Status:', response.status);
          console.log('Response OK:', response.ok);
          
          const data = await response.json();
          console.log('Response Data:', data);
          
          if (response.ok) {
            alert(data.message || '¡Agregado exitosamente!');
            form.reset();
            // Close modal
            const modal = form.closest('dialog') as HTMLDialogElement;
            modal?.close();
            // Reload page to show new data
            window.location.reload();
          } else {
            console.error('Error Response:', data);
            alert(data.error || 'Error al agregar');
          }
        } catch (error) {
         alert('Error de conexión con el servidor');
        }
      });
    });
  };

  const setupDeleteHandlers = () => {
    const deleteButtons = document.querySelectorAll('.delete-btn') as NodeListOf<HTMLButtonElement>;
    
    deleteButtons.forEach(button => {
      button.addEventListener('click', async (event) => {
        event.preventDefault();
        
        const id = button.getAttribute('data-id');
        const type = button.getAttribute('data-type');
        
        if (!id || !type) return;
        
        const confirmed = confirm(`¿Estás seguro de que quieres eliminar este ${type}?`);
        if (!confirmed) return;
        
        let endpoint = '';
        let payload: Record<string, any> = {};
        
        if (type === 'precedencia') {
          endpoint = '/api/precedence';
          payload = { idPrecedence: parseInt(id) };
        } 
        else if (type === 'instructor') {
          endpoint = '/api/instructor';
          payload = { idInstructor: parseInt(id) };
        } 
        else if (type === 'fiscal') {
          endpoint = '/api/fiscal';
          payload = { idFiscal: parseInt(id) };
        }
        
        try {
          const response = await fetch(endpoint, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
          });
          
          console.log('Response Status:', response.status);
          console.log('Response OK:', response.ok);
          
          const data = await response.json();
          console.log('Response Data:', data);
          
          if (response.ok) {
            alert(data.message || '¡Eliminado exitosamente!');
            window.location.reload();
          } else {
            console.error('Error Response:', data);
            alert(data.error || 'Error al eliminar');
          }
        } catch (error) {
         alert('Error de conexión con el servidor');
        }
      });
    });
  };

  window.addEventListener("keydown",(event) => {
      const activeModal = document.querySelector('dialog[open]') as HTMLDialogElement;
      
      if (event.key === "Escape" && activeModal) {
        event.preventDefault();
        event.stopImmediatePropagation();

        const activeElement = document.activeElement as HTMLInputElement | HTMLTextAreaElement;
        const isEditable = activeElement && (activeElement.tagName === "INPUT" || activeElement.tagName === "TEXTAREA");

        if (isEditable) {
          activeElement.value = "";
        }
      }
    },
    true, 
  );

  setupModals();
  setupFormHandlers();
  setupDeleteHandlers();
</script>